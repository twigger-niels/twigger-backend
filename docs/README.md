# Twigger Backend - System Documentation

Welcome to the comprehensive documentation for the Twigger Plant Database Backend System.

## üìö About This Directory

This directory contains **system-wide** documentation that affects multiple services or describes the overall architecture. For service-specific documentation, see the respective service's `docs/` folder (e.g., `backend/plant-service/docs/`).

For guidance on where documentation should live, see [`PROJECT_STRUCTURE.md`](../PROJECT_STRUCTURE.md) in the repository root.

## üèóÔ∏è System Overview

Twigger is a garden planning and plant database platform built with a microservices architecture. The backend consists of multiple specialized services that work together to provide plant data, garden management, and spatial features.

### Services

#### üå± Plant Service
**Purpose**: Comprehensive plant database with localized common names, growing conditions, and companion planting recommendations.

**Key Features**:
- Plant taxonomy (families, genera, species, cultivars)
- Multi-language common names and descriptions
- Growing conditions (sun, soil, water, hardiness zones)
- Physical characteristics (height, spread, growth rate)
- Companion planting relationships

**Documentation**: `backend/plant-service/docs/`

#### üè° Garden Service
**Purpose**: Spatial garden management using PostGIS for location-based features.

**Key Features**:
- Garden boundary creation and management
- Zone management (planting areas within gardens)
- Plant placement with spatial validation
- Workspace isolation for multi-tenant support

**Documentation**: `backend/garden-service/docs/`

#### üö™ API Gateway
**Purpose**: Single entry point for all client applications.

**Key Features**:
- Request routing to appropriate services
- Authentication and authorization
- Rate limiting and security
- Response aggregation

**Documentation**: `docs/swagger/` (generated)

## üõ†Ô∏è Technology Stack

- **Language**: Go 1.22+
- **Database**: PostgreSQL 17 with PostGIS 3.5
- **Authentication**: Firebase Auth
- **API**: GraphQL + REST
- **Cache**: Redis (planned)
- **Deployment**: Google Cloud Run (planned)

## üìä Database Architecture

**Single Database, Multiple Schemas**:
- All services share one PostgreSQL instance
- Logical separation through schema design
- Cross-service queries handled at application layer

**Key Features**:
- PostGIS for spatial data (gardens, zones, plant placements)
- GIN trigram indexes for full-text search (ILIKE queries)
- Multi-language support with 4-tier fallback chains
- GIST indexes for spatial queries
- Prepared statement pooling for performance

### Database Migrations

**Location**: `migrations/`

**Key Migrations**:
- `000_initial_schema.sql` - Base plant taxonomy
- `005_add_localization.sql` - Multi-language support (8 localization tables)
- `006_add_gin_trigram_indexes.sql` - Full-text search performance
- `007_add_spatial_indexes.sql` - Spatial query performance

**Running Migrations**:
```bash
# Run all pending migrations
go run cmd/migrate/main.go up

# Rollback last migration
go run cmd/migrate/main.go down
```

## üîå API Documentation

### Swagger/OpenAPI
- **Location**: `docs/swagger/`
- **Generated by**: swag
- **Access**: `/swagger/index.html` (when API gateway is running)

### GraphQL Schema
- **Location**: TBD
- **Playground**: TBD

## üß™ Testing

### Integration Tests
```bash
# Start test database (PostgreSQL 17 + PostGIS 3.5)
docker-compose -f docker-compose.test.yml up -d

# Run integration tests
go test ./... -tags=integration

# Cleanup
docker-compose -f docker-compose.test.yml down -v
```

### Performance Tests
```bash
# Run benchmarks
go test -bench=. ./backend/plant-service/...
```

## üöÄ Development

### Local Development Setup
```bash
# Start PostgreSQL with PostGIS
docker-compose up -d postgres

# Run migrations
go run cmd/migrate/main.go up

# Start API gateway
go run cmd/api-gateway/main.go
```

### Development Patterns

For detailed development patterns, see [`CLAUDE.md`](../CLAUDE.md) in the repository root, which includes:
- 45+ critical gotchas across 6 categories
- Code style guidelines (Go, SQL, testing)
- Localization patterns with fallback chains
- PostGIS spatial validation patterns
- Transaction management with savepoints
- Performance optimization strategies

## üîí Security

### Authentication
- Firebase Authentication tokens
- Token validation at API gateway
- User context propagation to services

### Authorization
- Workspace-based isolation
- Row-level security (planned)
- Garden ownership validation

### Data Validation
- Input validation at API layer
- GeoJSON structure and coordinate bounds validation
- SQL injection prevention (parameterized queries only)

## ‚ö° Performance Considerations

### Database Optimization
- **Spatial Indexes**: GIST on all geometry/geography columns (100x improvement)
- **Text Search**: GIN trigram indexes for ILIKE queries (100x improvement)
- **Prepared Statements**: Cached for frequently-used queries
- **Connection Pooling**: Max 25 connections, 5 idle, 5min lifetime

### Caching Strategy (Planned)
- Redis for lookup tables (families, genera, countries)
- Language-aware cache keys: `family:{id}:lang:{langID}:country:{countryID}`
- Pattern-based invalidation: `family:{id}:*`

### Localization Performance
- Batch loading to prevent N+1 queries
- Composite indexes: `(plant_id, language_id, country_id)`
- SQL-based 4-tier fallback chains (country+lang ‚Üí lang ‚Üí English ‚Üí key)

## üìà Project Status

### ‚úÖ Completed
- **Part 1**: Core plant taxonomy
- **Part 2**: Multi-language localization (8 tables, fallback chains)
- **Part 3**: Growing conditions, physical characteristics, filtering

### üîÑ In Progress
- **Part 4**: API layer (GraphQL/REST endpoints)

### ‚è≥ Planned
- **Part 5**: Companion planting recommendations
- **Phase 2**: Garden management (boundaries, zones, placements)
- **Phase 3**: Production deployment (Cloud Run, monitoring, caching)

## üìñ Documentation Index

### System-Wide (This Directory)
- `README.md` - This file (system overview)
- `swagger/` - Generated API documentation
- `ARCHITECTURE.md` - Detailed system architecture (TODO)
- `DEPLOYMENT.md` - Deployment guide (TODO)

### Repository Root
- `PROJECT_STRUCTURE.md` - How this repository is organized
- `CLAUDE.md` - Development patterns and 45+ critical gotchas

### Service-Specific
- `backend/plant-service/docs/` - Plant service (architecture, PRD, tasks)
- `backend/garden-service/docs/` - Garden service documentation
- `backend/shared/docs/` - Shared utility documentation

## üåü System Highlights

### Database Features
- **35+ tables** with comprehensive plant and garden data
- **13 measurement domains** for data standardization
- **7+ enum types** for controlled vocabularies
- **Full PostGIS spatial support** with analysis functions
- **Production-ready** with proper indexing and constraints

### Spatial Capabilities
- Country and climate zone boundaries (geography type)
- Garden mapping with zones and features (geometry + geography)
- Plant placement tracking with spatial validation
- Containment checks (ST_Contains) and distance calculations (ST_Distance)
- Multi-country climate zone support

### Data Quality
- Multi-source data with confidence scoring
- Source reliability tracking
- Scientific botanical naming standards (ICBN)
- Comprehensive plant taxonomy hierarchy

### Enterprise Features
- Multi-tenant workspace architecture
- Role-based access control (planned)
- Audit trails and data lineage
- Scalable cloud infrastructure (planned)

## üîó External Resources

### Documentation
- [PostGIS Documentation](https://postgis.net/documentation/)
- [PostgreSQL 17 Documentation](https://www.postgresql.org/docs/17/)
- [Google Cloud SQL](https://cloud.google.com/sql/docs)
- [Go 1.22+ Documentation](https://golang.org/doc/)

### Standards
- [Botanical Nomenclature (ICBN)](https://www.iapt-taxon.org/nomen/main.php)
- [GeoJSON Specification (RFC 7946)](https://tools.ietf.org/html/rfc7946)
- [ISO 3166 Country Codes](https://www.iso.org/iso-3166-country-codes.html)
- [USDA Hardiness Zones](https://planthardiness.ars.usda.gov/)

## ü§ù Contributing

### Development Workflow
1. Create feature branch from `main`
2. Write tests (unit + integration)
3. Implement feature following patterns in `CLAUDE.md`
4. Update documentation (service docs and/or system docs)
5. Run full test suite
6. Create pull request

### Commit Message Format
```
type(scope): subject

Examples:
- feat(plant-service): Add cultivar search endpoint
- fix(garden-service): Validate polygon closure before insert
- docs(system): Update deployment guide
- perf(plant-service): Add GIN index for common name search
- refactor(shared): Extract GeoJSON validator
- test(plant-service): Add integration tests for filters
```

## üìû Questions or Issues?

- **Development patterns**: Check root `CLAUDE.md` (45+ documented gotchas)
- **Service-specific questions**: Check `backend/{service}/docs/`
- **Repository organization**: See `PROJECT_STRUCTURE.md`
- **System architecture**: Review this file and service documentation

---

**Last Updated**: 2025-10-06
**Documentation Version**: 2.0 (Reorganized structure)
**System Status**: Part 3 Complete, Part 4 In Progress
