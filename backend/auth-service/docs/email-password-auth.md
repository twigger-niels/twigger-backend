# Email/Password Authentication Guide
**Version:** 1.1
**Date:** 2025-10-07
**Status:** Implemented
**Client Examples:** Flutter/Dart

---

## Overview

The Twigger backend now supports email/password registration as an optional authentication method alongside social providers (Google, Apple, Facebook). Firebase handles all password management, validation, and email verification - the backend only validates that email addresses are verified before allowing authentication.

**Key Features:**
- Firebase-managed password validation (min 8 chars, complexity rules)
- Automatic email verification via Firebase
- Same authentication flow as social providers
- Email verification required before first sign-in
- Secure storage of `email_verified` status

---

## Flutter Setup

### Required Dependencies

Add to `pubspec.yaml`:

```yaml
dependencies:
  flutter:
    sdk: flutter
  firebase_core: ^2.24.0
  firebase_auth: ^4.15.0
  http: ^1.1.0
```

### Firebase Initialization

```dart
import 'package:firebase_core/firebase_core.dart';
import 'firebase_options.dart'; // Generated by FlutterFire CLI

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );
  runApp(MyApp());
}
```

**Setup FlutterFire CLI:**
```bash
# Install FlutterFire CLI
dart pub global activate flutterfire_cli

# Configure Firebase project
flutterfire configure
```

---

## Architecture

### Firebase Responsibilities
- Password strength validation (min 8 characters)
- Secure password storage (bcrypt hashing)
- Email verification link generation and delivery
- JWT token issuance after successful authentication

### Backend Responsibilities
- Verify email is confirmed for `password` provider users
- Store `email_verified` status in database
- Reject unverified email/password users
- Allow social provider users regardless of verification status

---

## Registration Flow

### Client-Side (Flutter/Dart)

```dart
import 'package:firebase_auth/firebase_auth.dart';

Future<void> registerWithEmail(String email, String password) async {
  try {
    // 1. Register user with email/password using Firebase SDK
    final UserCredential userCredential = await FirebaseAuth.instance
        .createUserWithEmailAndPassword(
      email: email,
      password: password,
    );

    // 2. Send email verification
    await userCredential.user?.sendEmailVerification();

    // 3. Display message to user
    print("Please check your email to verify your account");
    // Show SnackBar or Dialog to user
  } on FirebaseAuthException catch (e) {
    if (e.code == 'weak-password') {
      print('The password provided is too weak.');
    } else if (e.code == 'email-already-in-use') {
      print('An account already exists for that email.');
    }
  }
}
```

### User Actions
1. User clicks registration button
2. App creates Firebase account
3. Firebase sends verification email
4. User clicks link in email
5. Firebase marks email as verified
6. User returns to app and signs in

### Backend Flow

```
┌─────────────────┐
│  User Signs In  │
│  (Email/Pass)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Firebase SDK    │
│ Authenticates   │
│ Returns JWT     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Client sends    │
│ POST /auth/     │
│ verify with JWT │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Middleware      │
│ Verifies JWT    │
│ Extracts claims │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Handler checks: │
│ provider ==     │
│ "password" &&   │
│ !emailVerified? │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
   Yes       No
    │         │
    ▼         ▼
┌───────┐ ┌──────────┐
│ Reject│ │ Continue │
│ 400   │ │ Auth Flow│
└───────┘ └──────────┘
```

---

## Authentication Flow

### Sign-In Process

```dart
import 'package:firebase_auth/firebase_auth.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';

Future<Map<String, dynamic>?> signInWithEmail(String email, String password) async {
  try {
    // 1. Sign in with email/password using Firebase SDK
    final UserCredential userCredential = await FirebaseAuth.instance
        .signInWithEmailAndPassword(
      email: email,
      password: password,
    );

    // 2. Get ID token
    final String? idToken = await userCredential.user?.getIdToken();

    if (idToken == null) {
      throw Exception('Failed to get ID token');
    }

    // 3. Send to backend
    final response = await http.post(
      Uri.parse('https://api.twigger.app/api/v1/auth/verify'),
      headers: {
        'Authorization': 'Bearer $idToken',
        'Content-Type': 'application/json',
      },
      body: jsonEncode({
        'device_id': 'flutter-device-id', // optional
      }),
    );

    // 4. Handle response
    if (response.statusCode == 200) {
      final data = jsonDecode(response.body);
      // Success - user authenticated
      print('User: ${data['user']}');
      print('Workspaces: ${data['workspaces']}');
      return data;
    } else if (response.statusCode == 400) {
      // Email not verified
      final error = jsonDecode(response.body);
      print('Error: ${error['error']}');
      // Show UI: "Please verify your email"
      throw Exception(error['error']);
    } else {
      throw Exception('Authentication failed');
    }
  } on FirebaseAuthException catch (e) {
    if (e.code == 'user-not-found') {
      print('No user found for that email.');
    } else if (e.code == 'wrong-password') {
      print('Wrong password provided.');
    }
    rethrow;
  }
}
```

---

## Backend Implementation

### Handler Verification Check

**File:** `internal/api-gateway/handlers/auth_handler.go`

```go
// Email/Password Registration: Require email verification
// Social providers (google.com, apple.com, facebook.com) don't need this check
if provider == "password" && !emailVerified {
    logError(r.Context(), "email not verified for password auth",
        fmt.Errorf("provider: %s, email_verified: %v", provider, emailVerified), firebaseUID)
    utils.RespondError(w, errors.New("Please verify your email address before signing in. Check your inbox for the verification link."))
    return
}
```

### Database Storage

**Table:** `users`

```sql
CREATE TABLE users (
    user_id UUID PRIMARY KEY,
    firebase_uid VARCHAR(128) UNIQUE,
    email VARCHAR(255) NOT NULL,
    email_verified BOOLEAN DEFAULT FALSE,  -- ✅ Stored here
    provider VARCHAR(50),                   -- 'password', 'google.com', etc.
    -- ... other fields
);
```

**Service:** `backend/auth-service/domain/service/auth_service.go`

```go
// createNewUser() stores email_verified
user := &entity.User{
    UserID:        uuid.New(),
    FirebaseUID:   &firebaseUID,
    Email:         email,
    Username:      generateUsernameWithRetry(ctx, tx, email),
    EmailVerified: emailVerified,  // ✅ From Firebase token
    PhotoURL:      photoURL,
    Provider:      provider,       // "password" for email/pass
    CreatedAt:     time.Now(),
}

// INSERT includes email_verified column
INSERT INTO users (
    user_id, firebase_uid, email, username, email_verified,
    phone_number, photo_url, provider, created_at, last_login_at
) VALUES (
    $1, $2, $3, $4, $5, $6, $7, $8, $9, $10
)
```

---

## Provider Comparison

| Provider       | Sign-in Method         | Email Verification | Notes                          |
|----------------|------------------------|--------------------|---------------------------------|
| `password`     | Email/Password         | **Required**       | Firebase validates password     |
| `google.com`   | Google OAuth           | Not required       | Google verifies email ownership |
| `apple.com`    | Apple Sign-In          | Not required       | Apple verifies email ownership  |
| `facebook.com` | Facebook Login         | Not required       | Facebook verifies email ownership |

---

## Error Codes and Messages

### Unverified Email (400 Bad Request)

```json
{
  "error": "Please verify your email address before signing in. Check your inbox for the verification link."
}
```

**When This Occurs:**
- User registered with email/password
- Has not clicked verification link in email
- Attempts to sign in

**Resolution:**
1. Check email inbox (including spam folder)
2. Click verification link
3. Return to app and sign in again

### Resend Verification Email

**Client-Side (Flutter):**
```dart
import 'package:firebase_auth/firebase_auth.dart';

Future<void> resendVerificationEmail() async {
  final User? user = FirebaseAuth.instance.currentUser;

  if (user != null && !user.emailVerified) {
    await user.sendEmailVerification();
    print('Verification email sent to ${user.email}');
  }
}
```

**Backend:** No action required - Firebase handles email delivery

---

## Testing

### Unit Tests

**File:** `backend/auth-service/domain/service/auth_service_email_test.go`

**Coverage:**
- ✅ Verified email/password users accepted
- ✅ Unverified email/password users rejected
- ✅ Social providers bypass verification check
- ✅ Email verification status stored correctly
- ✅ Provider types recognized correctly
- ✅ Error messages are user-friendly
- ✅ Audit logging captures verification attempts

**Run Tests:**
```bash
cd backend/auth-service
go test ./domain/service -v -run TestEmail
```

**Expected Output:**
```
=== RUN   TestEmailPasswordAuthentication_EmailVerified
✅ Email verification implementation verified
--- PASS: TestEmailPasswordAuthentication_EmailVerified (0.00s)

=== RUN   TestEmailPasswordAuthentication_EmailNotVerified
✅ Correctly rejects unverified email/password user
✅ Correctly accepts verified user or social provider
--- PASS: TestEmailPasswordAuthentication_EmailNotVerified (0.00s)

... (14 tests total, all passing)
```

### Manual Testing

#### Prerequisites
1. Firebase project configured
2. Email/Password provider enabled in Firebase Console
3. Email delivery working (check spam folder)

#### Test Scenario 1: Happy Path
1. Register user with email/password via Firebase SDK
2. Check email for verification link
3. Click link to verify
4. Sign in with email/password
5. Send JWT to `POST /api/v1/auth/verify`
6. **Expected:** 200 OK with user profile

#### Test Scenario 2: Unverified Email
1. Register user with email/password
2. **Do not click verification link**
3. Sign in with email/password (Firebase allows this)
4. Send JWT to `POST /api/v1/auth/verify`
5. **Expected:** 400 Bad Request with verification message

#### Test Scenario 3: Social Provider (No Verification Required)
1. Sign in with Google
2. Send JWT to `POST /api/v1/auth/verify`
3. **Expected:** 200 OK regardless of Google email verification status

---

## Security Considerations

### Password Security
- **Managed by Firebase:** Minimum 8 characters, complexity rules enforced
- **Backend Never Sees Password:** Only JWT tokens processed
- **Secure Storage:** Firebase uses bcrypt with salt

### Email Verification
- **Required for Password Provider:** Prevents registration spam
- **Not Required for Social:** Google/Apple/Facebook verify email ownership
- **Verification Link Expiry:** Firebase manages link lifetime (typically 24 hours)

### Account Enumeration Protection
- **Generic Error Messages:** Backend doesn't reveal if account exists
- **Rate Limiting:** 5 requests/min on `/auth/verify` endpoint
- **Audit Logging:** All verification attempts logged with IP/user agent

### GDPR Compliance
- **Email Storage:** User's email stored with consent
- **Data Portability:** `GET /api/v1/auth/export` exports all data
- **Account Deletion:** Soft delete with 30-day retention

---

## Troubleshooting

### User Not Receiving Verification Email

**Possible Causes:**
1. Email in spam folder
2. Firebase email delivery delayed
3. Invalid email address
4. Firebase quota exceeded

**Resolution:**
```dart
// Resend verification email
final User? user = FirebaseAuth.instance.currentUser;
if (user != null) {
  await user.sendEmailVerification();
}
```

### User Verified But Still Rejected

**Diagnosis:**
```bash
# Check user's verification status in Firebase Console
# Authentication → Users → Select User → Check "Email verified" column
```

**Common Causes:**
1. User signed in before clicking verification link (old JWT)
2. Token cached on client (not refreshed)

**Resolution:**
```dart
import 'package:firebase_auth/firebase_auth.dart';

// Force token refresh
final User? user = FirebaseAuth.instance.currentUser;
if (user != null) {
  await user.reload(); // Refresh user state
  final String? idToken = await user.getIdToken(true); // Force token refresh
  // Now use the new token to call backend
}
```

### Backend Logs Show "email not verified"

**Check Audit Logs:**
```sql
SELECT *
FROM auth_audit_log
WHERE user_id = 'user-uuid'
  AND event_type = 'user_login'
ORDER BY created_at DESC
LIMIT 10;
```

**Look for:**
- `metadata` column should show `"email_verified": false`
- `provider` column should show `"password"`

---

## Firebase Console Configuration

### Step 1: Enable Email/Password Provider

1. Go to Firebase Console: https://console.firebase.google.com
2. Select your project (twigger-prod)
3. Navigate to **Authentication** → **Sign-in method**
4. Click **Email/Password**
5. Enable **Email/Password**
6. Click **Save**

### Step 2: Configure Email Templates (Optional)

1. Navigate to **Authentication** → **Templates**
2. Select **Email address verification**
3. Customize:
   - **From name:** "Twigger Garden Planner"
   - **Reply-to:** support@twigger.app
   - **Subject:** "Verify your Twigger account"
   - **Body:** Customize with branding

### Step 3: Set Up Custom Domain (Optional)

For production, use custom email domain instead of `noreply@twigger-prod.firebaseapp.com`:

1. Navigate to **Authentication** → **Templates** → **SMTP settings**
2. Configure custom SMTP (e.g., SendGrid)
3. Verify domain ownership

---

## Migration from Social-Only to Email/Password

**No Migration Required!**

The backend already supports multiple providers:
- Existing users with Google/Apple/Facebook: No changes
- New users can register with email/password
- Users can link multiple providers to same account (future feature)

**Database Schema:**
- `users.provider` supports multiple values
- `users.email_verified` defaults to FALSE
- No breaking changes to existing data

---

## Metrics & Monitoring

### Success Metrics

- **Registration Completion Rate:** % of users who verify email
- **Provider Distribution:** Email/pass vs social providers
- **Verification Time:** Time from registration to verification
- **Failed Verification Attempts:** Rate of unverified sign-in attempts

### Monitoring Queries

```sql
-- Email verification rate (last 30 days)
SELECT
    COUNT(*) FILTER (WHERE email_verified = true) * 100.0 / COUNT(*) as verification_rate
FROM users
WHERE provider = 'password'
  AND created_at > NOW() - INTERVAL '30 days';

-- Provider distribution
SELECT
    provider,
    COUNT(*) as user_count,
    COUNT(*) * 100.0 / SUM(COUNT(*)) OVER () as percentage
FROM users
GROUP BY provider
ORDER BY user_count DESC;

-- Failed verification attempts (last 24 hours)
SELECT
    COUNT(*) as failed_attempts
FROM auth_audit_log
WHERE event_type = 'user_login'
  AND success = false
  AND metadata->>'error' LIKE '%email not verified%'
  AND created_at > NOW() - INTERVAL '24 hours';
```

---

## Future Enhancements

### Phase 3 (Post-MVP)
- [ ] Password reset flow (Firebase-managed)
- [ ] Account linking (merge Google + email accounts)
- [ ] Email change with re-verification
- [ ] Custom email templates with localization
- [ ] Magic link authentication (passwordless)

### Password Reset

**Already Supported by Firebase:**
```dart
import 'package:firebase_auth/firebase_auth.dart';

// Client-side password reset
Future<void> resetPassword(String email) async {
  try {
    await FirebaseAuth.instance.sendPasswordResetEmail(email: email);
    print('Password reset email sent to $email');
  } on FirebaseAuthException catch (e) {
    if (e.code == 'user-not-found') {
      print('No user found for that email.');
    }
  }
}
```

**Backend Impact:**
- None required - Firebase handles reset flow
- Optional: Track password reset events in audit log

---

## References

### Internal Documentation
- [PRD: Authentication System](./prd.md) - Section 4.1 "Email/Password Registration (Phase 2)"
- [Architecture Document](./architecture.md) - Section 4.5 "Email Verification"
- [Tasks Tracking](./tasks.md) - Phase 2.5 Email/Password Implementation

### Firebase Documentation
- [Firebase Flutter Setup](https://firebase.google.com/docs/flutter/setup)
- [Email/Password Authentication (Flutter)](https://firebase.google.com/docs/auth/flutter/password-auth)
- [Email Verification (Flutter)](https://firebase.google.com/docs/auth/flutter/manage-users#send_a_user_a_verification_email)
- [Password Reset (Flutter)](https://firebase.google.com/docs/auth/flutter/manage-users#send_a_password_reset_email)
- [Custom Email Templates](https://firebase.google.com/docs/auth/custom-email-handler)

### Flutter Packages
- [firebase_core](https://pub.dev/packages/firebase_core)
- [firebase_auth](https://pub.dev/packages/firebase_auth)
- [http](https://pub.dev/packages/http)

### Security Best Practices
- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
- [Firebase Security Best Practices](https://firebase.google.com/docs/auth/flutter/google-signin#security-concerns)

---

*Last Updated: 2025-10-07*
*Author: Claude Code*
*Version: 1.1 (Flutter/Dart examples)*
